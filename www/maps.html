<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GreeMind - Registro de Fincas</title>
<link rel="stylesheet" href="css/maps.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin: 0; display: flex; height: 100vh; font-family: Arial, sans-serif; }
  .sidebar { width: 300px; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; background: #fff; }
  .sidebar input, .sidebar button { width: 100%; margin-bottom: 10px; padding: 8px; }
  #map { flex: 1; height: 100%; }
</style>
</head>
<body>

<div class="sidebar">
    <h2>Registrar Finca</h2>
    <input type="hidden" id="editId">
    <input type="text" id="nombre_finca" placeholder="Nombre de la finca">
    <input type="text" id="propietario" placeholder="Propietario">
    <input type="text" id="direccion" placeholder="Dirección">
    <input type="number" step="0.000001" id="latitud" placeholder="Latitud">
    <input type="number" step="0.000001" id="longitud" placeholder="Longitud">
    <input type="number" step="0.01" id="area_total" placeholder="Área total (ha)">
    <button onclick="guardarFinca()">Guardar Finca</button>
    <hr>
    <div id="fincasList"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map, markers = [], fincas = [];

// Inicializar mapa
function initMap() {
    
    map = L.map('map').setView([12.8654, -85.2072], 7);

    const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    });

    const labelsLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Labels &copy; Esri'
    });

    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    });

    L.layerGroup([satLayer, labelsLayer]).addTo(map);

    const baseMaps = {
        "Mapa Normal": osmLayer,
        "Satelite + Nombres": L.layerGroup([satLayer, labelsLayer])
    };
    L.control.layers(baseMaps).addTo(map);

    const southWest = L.latLng(10.7, -87.7);
    const northEast = L.latLng(15.0, -83.0);
    map.setMaxBounds(L.latLngBounds(southWest, northEast));
    map.on('drag', () => map.panInsideBounds(L.latLngBounds(southWest, northEast), { animate: false }));

    cargarFincas();
}

// Cargar fincas desde backend
async function cargarFincas() {
    const res = await fetch('/api/fincas');
    fincas = await res.json();

    // Limpiar marcadores existentes
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const listDiv = document.getElementById('fincasList');
    listDiv.innerHTML = '';

    fincas.forEach(f => {
        // Marcador arrastrable
        const marker = L.marker([f.lat, f.lng], { draggable: true }).addTo(map)
            .bindPopup(`<b>${f.nombre}</b><br>${f.propietario}<br>${f.direccion}`);
        marker.on('dragend', async e => {
            const pos = e.target.getLatLng();
            document.getElementById('latitud').value = pos.lat.toFixed(6);
            document.getElementById('longitud').value = pos.lng.toFixed(6);
            document.getElementById('editId').value = f._id;
            // Actualizar automáticamente la base de datos
            await fetch(`/api/fincas/${f._id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...f, lat: pos.lat, lng: pos.lng })
            });
        });
        markers.push(marker);

        // Lista de fincas en sidebar
        const div = document.createElement('div');
        div.innerHTML = `<b>${f.nombre}</b> <button onclick="editarFinca('${f._id}')">Editar</button>
                         <button onclick="eliminarFinca('${f._id}')">Eliminar</button>`;
        listDiv.appendChild(div);
    });
}

// Guardar o editar finca
async function guardarFinca() {
    const editId = document.getElementById('editId').value;
    const data = {
        nombre: document.getElementById('nombre_finca').value,
        propietario: document.getElementById('propietario').value,
        direccion: document.getElementById('direccion').value,
        lat: parseFloat(document.getElementById('latitud').value),
        lng: parseFloat(document.getElementById('longitud').value),
        area: parseFloat(document.getElementById('area_total').value)
    };

    if(editId) {
        await fetch(`/api/fincas/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
    } else {
        await fetch('/api/fincas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
    }

    limpiarFormulario();
    cargarFincas();
}

function editarFinca(id) {
    const f = fincas.find(f => f._id === id);
    document.getElementById('editId').value = f._id;
    document.getElementById('nombre_finca').value = f.nombre;
    document.getElementById('propietario').value = f.propietario;
    document.getElementById('direccion').value = f.direccion;
    document.getElementById('latitud').value = f.lat;
    document.getElementById('longitud').value = f.lng;
    document.getElementById('area_total').value = f.area;
}

async function eliminarFinca(id) {
    if(confirm('¿Eliminar esta finca?')) {
        await fetch(`/api/fincas/${id}`, { method: 'DELETE' });
        cargarFincas();
    }
}

function limpiarFormulario() {
    document.getElementById('editId').value = '';
    document.getElementById('nombre_finca').value = '';
    document.getElementById('propietario').value = '';
    document.getElementById('direccion').value = '';
    document.getElementById('latitud').value = '';
    document.getElementById('longitud').value = '';
    document.getElementById('area_total').value = '';
}

document.addEventListener('DOMContentLoaded', initMap);
</script>

</body>
</html>